# shellcheck shell=sh disable=SC3043

# author:       Li Junhao           l@x-cmd.com    edwinjhlee.github.io
# maintainer:   Li Junhao

xrc os/v0

<<<<<<< HEAD
static_build_which(){
=======


static_build_run(){
    local _appname="${1:?Provide app name, like dust}"
    local s=${_appname#*"|"_appname}

    shift
    static_build_init "$_appname" && \
        "_${_appname}_bin" ${1:+"$@"}
}

static_build_run(){
    :

    # check in memory named list
    # not included. included.
    # 
}

static_build_init(){
>>>>>>> 3d1e1293beee688287a00a729e6f9052ce7a4309
    local appname="${1:?Provide app name, like dust}"

    if command -v "_${appname}_bin" 1>/dev/null; then
        return 0
    fi

    local target="$HOME/.x-cmd/.bin/$appname"
    mkdir -p "$target"

    local arch
    arch="$(os arch)"
    local osname
    osname="$(os name)"

    local exe
    case "$osname" in
        win)    exe=$appname.x64.exe        ;;
        *)      exe=$appname.${osname}.${arch}  ;;
    esac

    # Rely
    if [ ! -f "$target/$exe" ]; then
        # TODO: Use github, gitlab if gitee failed.
        if ! CACHE="$target/$exe.7z" xrc_curl "https://gitee.com/static-build/${appname}/raw/master/bin/$exe.7z"; then
            echo "Unsupported: $exe" >&2
            return 1
        fi

        (
            cd "$target" && {
                local size

                size=$(wc -c "$exe.7z")
                size=${size% *}
                size=$(printf "%s" $size)   # Notice: Intentionary let it unquoted.

                xrc p7zr
                if [ "$size" -gt 20 ]; then
                    p7zr x "$exe.7z" 1>/dev/null 2>/dev/null
                else
                    size="$(cat "$exe.7z")"
                    local i
                    local suffix
                    for i in $(seq "$size"); do
                        # suffix="$(printf "%03s" "$i")" # Not work in gnu bash
                        suffix="$(printf "%3s" "$i" | tr " " 0)"
                        CACHE="$exe.7z.$suffix" xrc_curl "https://gitee.com/static-build/${appname}/raw/master/bin/$exe.7z.$suffix" || {
                            echo "Fail in $exe.7z.$suffix" >&2
                            return 1
                        }
                    done
                    p7zr x "$exe.7z.001" 1>/dev/null 2>/dev/null
                fi && chmod +x "$exe"
            }
        )
    fi && printf "%s" "$target/$exe" && return 0

    return 1
}

static_build_init(){
    local name="${1:?Provide app name, like p7z}"
    local namebin="${2:-${name}_bin}"
    local path
    if ! path=$(_p7zr_which "$name"); then
        return 1
    fi
    eval "
        $namebin(){
            $path "$@" 
        }
    "
    # \${1:+\"\$@\"}
}

static_build_run(){
    local path
    if ! path=$(_p7zr_which "$name"); then
        return 1
    fi
    $path "$@"

    local _appname="${1:?Provide app name, like p7z}"
    shift
    static_build_init "$_appname" && "_${_appname}_bin" "$@"
}


static_build_xrc(){
    local _appname="${1:?Provide app name, like p7z}"
    static_build_init "$_appname"
}
